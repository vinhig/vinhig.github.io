<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Hijack Opengl Calls From Civilization 6 | Portfolio Vincent Higginson</title>
<meta name=keywords content>
<meta name=description content="Some people consume League of Legends on a regular basis. Others prefer spending time playing Counter Strike. Each people may have a specific addiction which he finds difficult to part with (and this addiction may not be a video game). During some part of my third year at uni (during covid) my addiction was clearly Civilization 6. I do not have to introduce it. A 4X game playable with friends during hours and hours.">
<meta name=author content>
<link rel=canonical href=http://vinhig.github.io/posts/hijack-opengl-calls-from-civ6/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.b9ff4cc257e914dab489bd18086151800e18f91456a5174bf28489210227a659.css integrity="sha256-uf9MwlfpFNq0ib0YCGFRgA4Y+RRWpRdL8oSJIQInplk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://vinhig.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=http://vinhig.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=http://vinhig.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=http://vinhig.github.io/apple-touch-icon.png>
<link rel=mask-icon href=http://vinhig.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.0">
<meta property="og:title" content="Hijack Opengl Calls From Civilization 6">
<meta property="og:description" content="Some people consume League of Legends on a regular basis. Others prefer spending time playing Counter Strike. Each people may have a specific addiction which he finds difficult to part with (and this addiction may not be a video game). During some part of my third year at uni (during covid) my addiction was clearly Civilization 6. I do not have to introduce it. A 4X game playable with friends during hours and hours.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://vinhig.github.io/posts/hijack-opengl-calls-from-civ6/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-31T14:35:23+02:00">
<meta property="article:modified_time" content="2021-08-31T14:35:23+02:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Hijack Opengl Calls From Civilization 6">
<meta name=twitter:description content="Some people consume League of Legends on a regular basis. Others prefer spending time playing Counter Strike. Each people may have a specific addiction which he finds difficult to part with (and this addiction may not be a video game). During some part of my third year at uni (during covid) my addiction was clearly Civilization 6. I do not have to introduce it. A 4X game playable with friends during hours and hours.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://vinhig.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Hijack Opengl Calls From Civilization 6","item":"http://vinhig.github.io/posts/hijack-opengl-calls-from-civ6/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hijack Opengl Calls From Civilization 6","name":"Hijack Opengl Calls From Civilization 6","description":"Some people consume League of Legends on a regular basis. Others prefer spending time playing Counter Strike. Each people may have a specific addiction which he finds difficult to part with (and this addiction may not be a video game). During some part of my third year at uni (during covid) my addiction was clearly Civilization 6. I do not have to introduce it. A 4X game playable with friends during hours and hours.","keywords":[],"articleBody":"Some people consume League of Legends on a regular basis. Others prefer spending time playing Counter Strike. Each people may have a specific addiction which he finds difficult to part with (and this addiction may not be a video game). During some part of my third year at uni (during covid) my addiction was clearly Civilization 6. I do not have to introduce it. A 4X game playable with friends during hours and hours. Available on Windows, Console and Linux, but unfortunately the Linux version is somewhat crappy… (Not to blame the developers, I’m sure they did their best with what they had). So one day, I decided to dive into the deep world of reverse engineering. Tadaaaaa!\nWhat was the goal? The raw computing part of Civilization 6 is directly linked to the artificial intelligence, something I wasn’t interested in, to be honest. Moreover, it wasn’t the main source of performance problems (according to absolutely no benchmark but my own intuition). So I decided to begin writing a little OpenGL library that would intercept all OpenGL calls from glX context creation, glX swapbuffers, … to gl compile shader, gl create buffer, … With some linker flags, it’s trivial. I began by writing a rust library exporting all glX functions.\n#[no_mangle] pub extern \"C\" fn glXGetClientString( display: *const c_void, name: c_int ) - *const c_char { /* */ } #[no_mangle] pub extern \"C\" fn glXMakeCurrent( display: *const c_void, drawable: *const c_void, context: *const c_void, ) - bool { /* */ } // blah blah Read https://github.com/vinhig/probriquegl/blob/master/src/glx.rs for reference. When you want to create an OpenGL context (think about a link between your application and the driver), you use a bunch of glX calls to specify the desired version, the linked window, when you want to swap buffers, etc. The first step of my little library was to allow my game to run on my ooold computer: Intel HD 3000 powered beast. Sadly, it’s an OpenGL 3.3 max GPU. Obviously, it doesn’t normally run civ6. Normally? Remember, I have the control over the glX context glX context creation procedure… So why not changing some attributes value? Wow! It works!\nCan we do more things? By modifying the glX get proc address function, we can redirect all OpenGL calls. Before OpenGL 4.6 and the advent of SPIR-V, all shaders are give to the driver in text format. That means it can be easily read and modified. After some days, I managed to create a basic shader reloader probriquegl:\n A the start of the game, each shader passed to glShaderSource is identified by a unique ID and saved on disk. A interactive terminal appears, allowing the user to reload a shader by its identifier.  What’s not working? When you choose to reload a shader after applying modifications, you sometimes choose to not use some uniforms. That’s ok, I won’t be mad… but the driver, yes. Previously retrieved uniform locations requested by the game are all invalid now :/ It would require a lot of work, but a possible solution would be:\n For each compiled program, create a table of all uniforms (register each time the game requests its location). Each entry contains the name, the original uniform location and an optional alternative uniform location. For each shader recompilation, modify table of all uniforms for this program:  If a uniform disappear (optimized out, for example), register is as unused. If a uniform disappear, request all uniforms location by their name and update the alternative uniform location.   Each time the game is using a uniform location, optionally replace it by the alternative uniform location for the currently bound program. If the uniform disappeared, do not accept the call.  A solution requiring some level of indirection for each shader-related call.\nConclusion So the building blocks of a bigger project are ready. To be honest, before stopping working on it, I thought it would be a great idea to create a “minified” version of Civilization 6 playable on your little laptop without having it consuming your whole battery. Modifying meshes, textures would require detecting the pattern of resource creation to correctly identify which object is currently being uploaded. A though work I’m not even sure someone would actually use.\n","wordCount":"702","inLanguage":"en","datePublished":"2021-08-31T14:35:23+02:00","dateModified":"2021-08-31T14:35:23+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://vinhig.github.io/posts/hijack-opengl-calls-from-civ6/"},"publisher":{"@type":"Organization","name":"Portfolio Vincent Higginson","logo":{"@type":"ImageObject","url":"http://vinhig.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://vinhig.github.io/ accesskey=h title="Portfolio Vincent Higginson (Alt + H)">Portfolio Vincent Higginson</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Hijack Opengl Calls From Civilization 6
</h1>
<div class=post-meta>August 31, 2021
</div>
</header>
<div class=post-content><p>Some people consume League of Legends on a regular basis. Others prefer spending time playing Counter Strike. Each people may have a specific addiction which he finds difficult to part with (and this addiction may not be a video game). During some part of my third year at uni (during covid) my addiction was clearly Civilization 6. I do not have to introduce it. A 4X game playable with friends during hours and hours. Available on Windows, Console and Linux, but unfortunately the Linux version is somewhat crappy&mldr; (Not to blame the developers, I&rsquo;m sure they did their best with what they had). So one day, I decided to dive into the deep world of reverse engineering. Tadaaaaa!</p>
<h2 id=what-was-the-goal>What was the goal?<a hidden class=anchor aria-hidden=true href=#what-was-the-goal>#</a></h2>
<p>The raw computing part of Civilization 6 is directly linked to the artificial intelligence, something I wasn&rsquo;t interested in, to be honest. Moreover, it wasn&rsquo;t the main source of performance problems (according to absolutely no benchmark but my own intuition). So I decided to begin writing a little OpenGL library that would intercept all OpenGL calls from glX context creation, glX swapbuffers, &mldr; to gl compile shader, gl create buffer, &mldr; With some linker flags, it&rsquo;s trivial. I began by writing a rust library exporting all glX functions.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#75715e>#[no_mangle]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>glXGetClientString</span>(
    display: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_void,
    name: <span style=color:#a6e22e>c_int</span>
) -&gt; <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_char { <span style=color:#75715e>/* */</span> }

<span style=color:#75715e>#[no_mangle]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>glXMakeCurrent</span>(
    display: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_void,
    drawable: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_void,
    context: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_void,
) -&gt; <span style=color:#66d9ef>bool</span> { <span style=color:#75715e>/* */</span> }

<span style=color:#75715e>// blah blah
</span></code></pre></div><p>Read <a href=https://github.com/vinhig/probriquegl/blob/master/src/glx.rs>https://github.com/vinhig/probriquegl/blob/master/src/glx.rs</a> for reference. When you want to create an OpenGL context (think about a link between your application and the driver), you use a bunch of glX calls to specify the desired version, the linked window, when you want to swap buffers, etc. The first step of my little library was to allow my game to run on my ooold computer: Intel HD 3000 powered <em>beast</em>. Sadly, it&rsquo;s an OpenGL 3.3 max GPU. Obviously, it doesn&rsquo;t normally run civ6. Normally? Remember, I have the control over the glX context <a href=https://github.com/vinhig/probriquegl/blob/90dc4289262f9c24f06f12b9240d0337444ba6d2/src/glx.rs#L402>glX context creation procedure</a>&mldr; So why not changing some attributes value? Wow! It works!</p>
<p><img loading=lazy src=/images/civ6-on-intel-hd-3000.png alt="Civilization 6 on Intel HD 3000">
</p>
<p>Can we do more things? By modifying the <a href=https://github.com/vinhig/probriquegl/blob/90dc4289262f9c24f06f12b9240d0337444ba6d2/src/glx.rs#L374>glX get proc address</a> function, we can redirect all OpenGL calls. Before OpenGL 4.6 and the advent of SPIR-V, all shaders are give to the driver in text format. That means it can be easily read and <em>modified</em>. After some days, I managed to create a basic shader reloader <code>probriquegl</code>:</p>
<ol>
<li>A the start of the game, each shader passed to <a href=https://github.com/vinhig/probriquegl/blob/90dc4289262f9c24f06f12b9240d0337444ba6d2/src/gl.rs#L75>glShaderSource</a> is identified by a unique ID and saved on disk.</li>
<li>A interactive terminal appears, allowing the user to <a href=https://github.com/vinhig/probriquegl/blob/90dc4289262f9c24f06f12b9240d0337444ba6d2/src/lib.rs#L213>reload a shader by its identifier</a>.</li>
</ol>
<h2 id=whats-not-working>What&rsquo;s not working?<a hidden class=anchor aria-hidden=true href=#whats-not-working>#</a></h2>
<p>When you choose to reload a shader after applying modifications, you sometimes choose to not use some uniforms. That&rsquo;s ok, I won&rsquo;t be mad&mldr; but the driver, <strong>yes</strong>. Previously retrieved uniform locations requested by the game are all invalid now :/ It would require a lot of work, but a possible solution would be:</p>
<ol>
<li>For each compiled program, create a table of all uniforms (register each time the game requests its location). Each entry contains the name, the original uniform location and an optional alternative uniform location.</li>
<li>For each shader recompilation, modify table of all uniforms for this program:
<ol>
<li>If a uniform disappear (optimized out, for example), register is as <em>unused</em>.</li>
<li>If a uniform disappear, request all uniforms location by their name and update the alternative uniform location.</li>
</ol>
</li>
<li>Each time the game is using a uniform location, optionally replace it by the alternative uniform location for the currently bound program. If the uniform disappeared, do not accept the call.</li>
</ol>
<p>A solution requiring some level of indirection for each shader-related call.</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>So the building blocks of a bigger project are ready. To be honest, before stopping working on it, I thought it would be a great idea to create a &ldquo;minified&rdquo; version of Civilization 6 playable on your little laptop without having it consuming your whole battery. Modifying meshes, textures would require detecting the pattern of resource creation to correctly identify which object is currently being uploaded. A though work I&rsquo;m not even sure someone would actually use.</p>
</div>
<footer class=post-footer>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=http://vinhig.github.io/>Portfolio Vincent Higginson</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>